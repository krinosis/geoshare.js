function cross_down(s){var e=positionX(),t=positionY();plot_point_cross(e,t,color),user.cross_points.push([e,t,color]),undo_stack.push("cross_points"),modify=!0,undo_btn.firstChild.src="src/core/img/undo-active.png",reset_redo()}function dot_down(s){var e=positionX(),t=positionY();plot_point_circle(e,t,color),user.dot_points.push([e,t,color]),undo_stack.push("dot_points"),modify=!0,undo_btn.firstChild.src="src/core/img/undo-active.png",reset_redo()}function label_down(s){var e=positionX(),t=positionY();display_textbox(e,t,"label"),undo_stack.push("labels"),modify=!0,undo_btn.firstChild.src="src/core/img/undo-active.png",reset_redo()}function solid_down(s){x1=positionX(),y1=positionY();var e=get_snap_point(x1,y1);null!=e&&(x1=e[0],y1=e[1]),locks.solid_line_move=!1}function solid_move(s){restore_canvas(),x2=positionX(),y2=positionY();var e=get_snap_point(x2,y2);null!=e&&(x2=e[0],y2=e[1],highlight_point(e[0],e[1],SNAP_POINT_THRES)),draw_solid_line(x1,y1,x2,y2,color),user.solid_lines.push([x1,y1,x2,y2,color]),emitable&&emit_data(),user.solid_lines.pop()}function solid_up(s){restore_canvas(),locks.solid_line_move=!0,x2=positionX(),y2=positionY();var e=get_snap_point(x2,y2);null!=e&&(x2=e[0],y2=e[1]),length_line(x1,y1,x2,y2)>SNAP_POINT_THRES&&(draw_solid_line(x1,y1,x2,y2,color),user.solid_lines.push([x1,y1,x2,y2,color]),undo_stack.push("solid_lines"),modify=!0,undo_btn.firstChild.src="src/core/img/undo-active.png",reset_redo()),context.fillText((length_line(x1,y1,x2,y2)/interval).toFixed(2),x2+5,y2-5),setTimeout(function(){restore_canvas()},1e3),x1=y1=x2=y2=null}function dashed_down(s){x1=positionX(),y1=positionY();var e=get_snap_point(x1,y1);null!=e&&(x1=e[0],y1=e[1]),locks.dashed_line_move=!1}function dashed_move(s){restore_canvas(),x2=positionX(),y2=positionY();var e=get_snap_point(x2,y2);null!=e&&(x2=e[0],y2=e[1],highlight_point(e[0],e[1],SNAP_POINT_THRES)),draw_dashed_line(x1,y1,x2,y2,color),user.dashed_lines.push([x1,y1,x2,y2,color]),emitable&&emit_data(),user.dashed_lines.pop()}function dashed_up(s){restore_canvas(),locks.dashed_line_move=!0,x2=positionX(),y2=positionY();var e=get_snap_point(x2,y2);null!=e&&(x2=e[0],y2=e[1]),length_line(x1,y1,x2,y2)>SNAP_POINT_THRES&&(draw_dashed_line(x1,y1,x2,y2,color),user.dashed_lines.push([x1,y1,x2,y2,color]),undo_stack.push("dashed_lines"),modify=!0,undo_btn.firstChild.src="src/core/img/undo-active.png",reset_redo()),x1=y1=x2=y2=null}function height_down(s){x1=positionX(),y1=positionY();var e=get_snap_point(x1,y1);null!=e&&(x1=e[0],y1=e[1]),locks.height_move=!1}function height_move(s){if(!locks.height_move){restore_canvas(),x2=positionX(),y2=positionY();var e=get_snap_point_height(x1,y1,x2,y2);null!=e&&(x2=e[0],y2=e[1],draw_dashed_line(e[0],e[1],e[5],e[6],color)),draw_solid_line(x1,y1,x2,y2,color),user.heights.push([x1,y1,x2,y2,null,null,null,null,null,null,null,null,null,null,null,null,color]),emitable&&emit_data(),user.heights.pop(),highlight_heights(x1,y1,x2,y2)}}function height_up(s){restore_canvas(),locks.height_move=!0,x2=positionX(),y2=positionY();var e=get_snap_point_height(x1,y1,x2,y2);if(null!=e){x2=e[0],y2=e[1],draw_solid_line(x1,y1,x2,y2,color);var t=e[2],o=e[3],i=(length_line(t,o,x2,y2),length_line(x1,y1,x2,y2),5);if(x1!=x2)var r=(y1-y2)/(x1-x2),l=i/Math.sqrt(1+r*r)*((x1-x2)/Math.abs(x2-x1))+x2,n=r*(l-x2)+y2;else var l=x2,n=y2-i*((y2-y1)/Math.abs(y2-y1));if(t!=x2)var r=(o-y2)/(t-x2),a=i/Math.sqrt(1+r*r)*((t-x2)/Math.abs(x2-t))+x2,h=r*(a-x2)+y2;else var a=x2,h=y2-i*((y2-o)/Math.abs(y2-o));var c=(l+a)/2,_=(n+h)/2,p=2*c-x2,d=2*_-y2;draw_solid_line(l,n,p,d),draw_solid_line(a,h,p,d),_top_point=get_nearest_point_name(x1,y1);var u=(null!=_top_point?_top_point[3]:"",null!=_top_point?0:null);user.heights.push([x1,y1,parseFloat(x2.toFixed(4)),parseFloat(y2.toFixed(4)),parseFloat(l.toFixed(4)),parseFloat(n.toFixed(4)),parseFloat(a.toFixed(4)),parseFloat(h.toFixed(4)),parseFloat(p.toFixed(4)),parseFloat(d.toFixed(4)),_top_point,"",u,null,e[7],e[8],color]),undo_stack.push("heights"),e[4]&&(draw_dashed_line(e[0],e[1],e[5],e[6],color),user.dashed_lines.push([e[0],e[1],e[5],e[6],color]),modify=!0,undo_btn.firstChild.src="src/core/img/undo-active.png",reset_redo())}x1=y1=x2=y2=null}function circle_down(s){x1=positionX(),y1=positionY();var e=get_snap_point(x1,y1);null!=e&&(x1=e[0],y1=e[1]),plot_point_circle(x1,y1,color),locks.circle_move=!1}function circle_move(s){locks.circle_move||(restore_canvas(),x2=positionX(),y2=positionY(),plot_point_circle(x1,y1,color),draw_arc(x1,y1,length_line(x1,y1,x2,y2),0,2*Math.PI,!1,color),user.circles.push([parseFloat(x1.toFixed(2)),parseFloat(y1.toFixed(2)),parseFloat(length_line(x1,y1,x2,y2).toFixed(2)),color]),emitable&&emit_data(),user.circles.pop())}function circle_up(s){restore_canvas(),x2=positionX(),y2=positionY(),locks.circle_move=!0,Math.abs(y2-y1)>2||Math.abs(x2-x1)>2?(plot_point_circle(x1,y1,color),draw_arc(x1,y1,length_line(x1,y1,x2,y2),0,2*Math.PI,!1,color),user.circles.push([parseFloat(x1.toFixed(2)),parseFloat(y1.toFixed(2)),parseFloat(length_line(x1,y1,x2,y2).toFixed(2)),color]),undo_stack.push("circles")):alert("Press, hold & drag the mouse to draw circle"),x1=y1=x2=y2=null,modify=!0,undo_btn.firstChild.src="src/core/img/undo-active.png",reset_redo()}function compass_down(s){if(locks.compass_draw&&locks.compass_rad)restore_canvas(),ox=positionX(),oy=positionY(),plot_point_circle(ox,oy,color);else if(!locks.compass_rad){locks.compass_rad=!0,x1=positionX(),y1=positionY(),plot_point_circle(ox,oy,color),plot_point_circle(x1,y1,color),draw_dashed_line(ox,oy,x1,y1,color),user.compass.push([color,[parseFloat(x1.toFixed(2)),parseFloat(y1.toFixed(2))]]);var e=x1-ox,t=y1-oy;r3=Math.sqrt(e*e+t*t),locks.compass_draw=!1}}function compass_move(s){var e=positionX(),t=positionY();restore_canvas(),plot_point_circle(e,t,color),null!=ox&&plot_point_circle(ox,oy,color),draw_compass(e,t,e,t)}function compass_radius(s){x1=positionX(),y1=positionY(),restore_canvas(),context.fillStyle="grey",plot_point_circle(ox,oy,color),plot_point_circle(x1,y1,color),draw_dashed_line(ox,oy,x1,y1,"grey"),context.fillText((length_line(ox,oy,x1,y1)/interval).toFixed(2),(ox+x1)/2,(oy+y1)/2),draw_compass(ox,oy,x1,y1)}function compass_draw(s){restore_canvas(),context.fillStyle="grey",x2=positionX(),y2=positionY(),plot_point_circle(ox,oy,color),Math.abs(x2-x1)<2*interval&&Math.abs(y2-y1)<2*interval?(_snaps=get_circle_snap_points(x2,y2,ox,oy,r3),plot_point_circle(_snaps[0],_snaps[1],color),draw_solid_line(x1,y1,_snaps[0],_snaps[1],color),draw_dashed_line(ox,oy,_snaps[0],_snaps[1],color),context.fillText((r3/interval).toFixed(2),(ox+_snaps[0])/2,(oy+_snaps[1])/2),(Math.abs(_snaps[0]-x1)>=seg||Math.abs(_snaps[1]-y1)>=seg)&&(x1=_snaps[0],y1=_snaps[1],user.compass[user.compass.length-1].push([parseFloat(x1.toFixed(2)),parseFloat(y1.toFixed(2))]),emitable&&emit_data())):(draw_dashed_line(ox,oy,x2,y2,color),plot_point_circle(x2,y2,color)),draw_compass(ox,oy,x1,y1)}function compass_up(s){locks.compass_rad&&locks.compass_draw?locks.compass_rad=!1:locks.compass_draw||(locks.compass_draw=!0,_snaps=get_circle_snap_points(x2,y2,ox,oy,r3),user.compass[user.compass.length-1].push([parseFloat(_snaps[0].toFixed(2)),parseFloat(_snaps[1].toFixed(2))]),ox=oy=x1=y1=x2=y2=r=r2=r3=null,undo_stack.push("compass"),context.fillStyle=color),modify=!0,undo_btn.firstChild.src="src/core/img/undo-active.png",reset_redo()}function ruler_down(s){if(ox=positionX(),oy=positionY(),0==user.ruler.length)user.ruler=[ox,oy,ox+(author_w-1)*interval+10,oy],ox=oy=null;else if(null==ruler_action){var e=length_line(user.ruler[0],user.ruler[1],user.ruler[2],user.ruler[3]);length_line(ox,oy,user.ruler[0],user.ruler[1])<e/4?ruler_action="left":length_line(ox,oy,user.ruler[2],user.ruler[3])<e/4?ruler_action="right":ruler_action="move"}else ruler_action=null}function ruler_move(s){var e=positionX(),t=positionY();if(restore_canvas(),0==user.ruler.length)ruler_action=null,context.drawImage(img_ruler,e,t),user.ruler=[e,t,e+(author_w-1)*interval+10,t],emitable&&emit_data(),user.ruler=[];else{var o=length_line(user.ruler[0],user.ruler[1],user.ruler[2],user.ruler[3]);null!=ruler_action?("left"==ruler_action?(_snaps=get_circle_snap_points(e,t,user.ruler[2],user.ruler[3],o),user.ruler[0]=_snaps[0],user.ruler[1]=_snaps[1]):"right"==ruler_action?(_snaps=get_circle_snap_points(e,t,user.ruler[0],user.ruler[1],o),user.ruler[2]=_snaps[0],user.ruler[3]=_snaps[1]):(user.ruler=[user.ruler[0]+=e-ox,user.ruler[1]+=t-oy,user.ruler[2]+=e-ox,user.ruler[3]+=t-oy],ox=e,oy=t),emitable&&emit_data(),restore_canvas()):length_line(e,t,user.ruler[0],user.ruler[1])<o/4?(canvas.style.cursor="alias",highlight_point(user.ruler[0],user.ruler[1],o/4)):length_line(e,t,user.ruler[2],user.ruler[3])<o/4?(canvas.style.cursor="alias",highlight_point(user.ruler[2],user.ruler[3],o/4)):canvas.style.cursor="move"}}function ruler_up(s){ruler_action=null}function protr_down(s){ox=positionX(),oy=positionY(),0==user.protr.length?(user.protr=[ox-136,oy,ox+136,oy],ox=oy=null):null==protr_action?length_line(ox,oy,user.protr[0],user.protr[1])<SNAP_EDGE_THRES?protr_action="left":length_line(ox,oy,user.protr[2],user.protr[3])<SNAP_EDGE_THRES?protr_action="right":protr_action="move":protr_action=null}function protr_move(s){var e=positionX(),t=positionY();restore_canvas(),0==user.protr.length?(protr_action=null,context.drawImage(img_protractor,e-136,t-137),user.protr=[e-136,t,e+136,t],emitable&&emit_data(),user.protr=[]):null!=protr_action?("left"==protr_action?(_snaps=get_circle_snap_points(e,t,(user.protr[0]+user.protr[2])/2,(user.protr[1]+user.protr[3])/2,length_line(user.protr[0],user.protr[1],user.protr[2],user.protr[3])/2),user.protr=[_snaps[0],_snaps[1],user.protr[0]+user.protr[2]-_snaps[0],user.protr[1]+user.protr[3]-_snaps[1]]):"right"==protr_action?(_snaps=get_circle_snap_points(e,t,(user.protr[0]+user.protr[2])/2,(user.protr[1]+user.protr[3])/2,length_line(user.protr[0],user.protr[1],user.protr[2],user.protr[3])/2),user.protr=[user.protr[0]+user.protr[2]-_snaps[0],user.protr[1]+user.protr[3]-_snaps[1],_snaps[0],_snaps[1]]):(user.protr=[user.protr[0]+=e-ox,user.protr[1]+=t-oy,user.protr[2]+=e-ox,user.protr[3]+=t-oy],ox=e,oy=t),emitable&&emit_data(),restore_canvas()):length_line(e,t,user.protr[0],user.protr[1])<SNAP_EDGE_THRES?(canvas.style.cursor="alias",highlight_point(user.protr[0],user.protr[1],SNAP_EDGE_THRES)):length_line(e,t,user.protr[2],user.protr[3])<SNAP_EDGE_THRES?(canvas.style.cursor="alias",highlight_point(user.protr[2],user.protr[3],SNAP_EDGE_THRES)):canvas.style.cursor="move"}function protr_up(s){protr_action=null}function select_down(s){if(locks.trans)null==moving_transition?(x1=positionX(),y1=positionY(),locks.select_move=!1,select_action=null):locks.trans=!1;else{ox=positionX(),oy=positionY();var e=(x1+x2)/2,t=(y1+y2)/2,o=Math.min(Math.abs(x2-x1),Math.abs(y2-y1))/5;moving_transition=highlight_selected(x1,y1,x2,y2),length_line(ox,oy,x1,y1)<o||length_line(ox,oy,x1,y2)<o||length_line(ox,oy,x2,y1)<o||length_line(ox,oy,x2,y2)<o?select_action="rotate":length_line(ox,oy,e,y1)<o?select_action="scale-top":length_line(ox,oy,e,y2)<o?select_action="scale-down":length_line(ox,oy,x1,t)<o?select_action="scale-left":length_line(ox,oy,x2,t)<o?select_action="scale-right":x1<=ox&&ox<=x2&&y1<=oy&&oy<=y2?select_action="move":(locks.trans=!0,locks.select_move=!0,x1=x2=y1=y2=null,moving_transition=null,user.select=[])}}function select_move(s){if(locks.select_move||(restore_canvas(),x2=positionX(),y2=positionY(),user.select=[x1,y1,x2,y2],moving_transition=highlight_selected(x1,y1,x2,y2)),!locks.trans){restore_canvas();var e=positionX(),t=positionY();if(null!=select_action)if("rotate"==select_action){var o=(x1+x2)/2,i=(y1+y2)/2,r=Math.atan2(oy-i,ox-o),l=Math.atan2(t-i,e-o),n=l-r;restore_transition(moving_transition,0,0,null,[n,o,i])}else"scale-left"==select_action?(highlight_selected(x1+e-ox,y1,x2-(e-ox),y2),user.select=[x1+e-ox,y1,x2-(e-ox),y2],restore_transition(moving_transition,e-ox,0,[(x1+x2)/2,null,(x1+x2)/2-ox,null])):"scale-right"==select_action?(highlight_selected(x1-(e-ox),y1,x2+e-ox,y2),user.select=[x1-(e-ox),y1,x2+e-ox,y2],restore_transition(moving_transition,-(e-ox),0,[(x1+x2)/2,null,(x1+x2)/2-ox,null])):"scale-top"==select_action?(highlight_selected(x1,y1+t-oy,x2,y2-(t-oy)),user.select=[x1,y1+t-oy,x2,y2-(t-oy)],restore_transition(moving_transition,0,t-oy,[null,(y1+y2)/2,null,(y1+y2)/2-oy])):"scale-down"==select_action?(highlight_selected(x1,y1-(t-oy),x2,y2+t-oy),user.select=[x1,y1-(t-oy),x2,y2+t-oy],restore_transition(moving_transition,0,-(t-oy),[null,(y1+y2)/2,null,(y1+y2)/2-oy])):"move"==select_action&&(highlight_selected(x1+e-ox,y1+t-oy,x2+e-ox,y2+t-oy),user.select=[x1+e-ox,y1+t-oy,x2+e-ox,y2+t-oy],restore_transition(moving_transition,e-ox,t-oy,[]));else{var a=Math.min(Math.abs(x2-x1),Math.abs(y2-y1))/5;length_line(e,t,x1,y1)<a?(canvas.style.cursor="alias",highlight_point(x1,y1,a)):length_line(e,t,x1,y2)<a?(canvas.style.cursor="alias",highlight_point(x1,y2,a)):length_line(e,t,x2,y1)<a?(canvas.style.cursor="alias",highlight_point(x2,y1,a)):length_line(e,t,x2,y2)<a?(canvas.style.cursor="alias",highlight_point(x2,y2,a)):length_line(e,t,x1,(y1+y2)/2)<a?(canvas.style.cursor="e-resize",highlight_point(x1,(y1+y2)/2,a)):length_line(e,t,(x1+x2)/2,y1)<a?(canvas.style.cursor="n-resize",highlight_point((x1+x2)/2,y1,a)):length_line(e,t,x2,(y1+y2)/2)<a?(canvas.style.cursor="e-resize",highlight_point(x2,(y1+y2)/2,a)):length_line(e,t,(x1+x2)/2,y2)<a?(canvas.style.cursor="n-resize",highlight_point((x1+x2)/2,y2,a)):x1<=e&&e<=x2&&y1<=t&&t<=y2?canvas.style.cursor="move":canvas.style.cursor="default"}}}function select_up(s){restore_canvas(),x1=Math.min(user.select[0],user.select[2]),y1=Math.min(user.select[1],user.select[3]),x2=Math.max(user.select[0],user.select[2]),y2=Math.max(user.select[1],user.select[3]),transition_data_not_empty(moving_transition)?(locks.del=locks.copy=!0,del_btn.firstChild.src="src/core/img/del-passive.png",copy_btn.firstChild.src="src/core/img/copy-passive.png"):(locks.del=locks.copy=!1,del_btn.firstChild.src="src/core/img/del-active.png",copy_btn.firstChild.src="src/core/img/copy-active.png"),locks.select_move?(select_action=null,null!=moving_transition&&(0!=undo_stack.length&&"trans"!=undo_stack[undo_stack.length-1]&&(user.trans.push(moving_transition),undo_stack.push("trans")),moving_transition=highlight_selected(x1,y1,x2,y2),user.trans.push(moving_transition),undo_stack.push("trans"))):(locks.select_move=!0,locks.trans=!1)}function draw_solid_line(s,e,t,o,i,r){context.strokeStyle=i,null!=r&&(context.lineWidth=r),context.beginPath(),context.moveTo(s,e),context.lineTo(t,o),context.closePath(),context.stroke(),context.lineWidth=1}function draw_dashed_line(s,e,t,o,i){context.beginPath(),context.strokeStyle=i;var r=t-s,l=o-e,n=Math.atan2(l,r),a=s,h=e;context.moveTo(s,e);for(var c=0,_=!0;!(r<0?a<=t:a>=t)||!(l<0?h<=o:h>=o);){var p=DASH_PATTERN[c++%DASH_PATTERN.length],d=a+Math.cos(n)*p;a=r<0?Math.max(t,d):Math.min(t,d);var u=h+Math.sin(n)*p;h=l<0?Math.max(o,u):Math.min(o,u),_?context.lineTo(a,h):context.moveTo(a,h),_=!_}context.closePath(),context.stroke()}function plot_point_cross(s,e,t){draw_solid_line(s-3,e-3,s+3,e+3,t),draw_solid_line(s+3,e-3,s-3,e+3,t)}function plot_point_circle(s,e,t){context.strokeStyle=t,context.beginPath(),context.arc(s,e,1,0,2*Math.PI,!0),context.stroke()}function draw_arc(s,e,t,o,i,r,l){context.strokeStyle=l,context.beginPath(),context.arc(s,e,t,o,i,r),context.stroke()}var geoshare=function(s,e){function t(){H.font=Y,draw_solid_line(0,0,0,D.height,"blue"),draw_solid_line(0,0,D.width,0,"blue"),draw_solid_line(0,D.height,D.width,D.height,"blue"),draw_solid_line(D.width,0,D.width,D.height,"blue"),H.lineWidth=.5,D.addEventListener("mousedown",mouse_down_handler,!1),D.addEventListener("mousemove",mouse_move_handler,!1),D.addEventListener("mouseup",mouse_up_handler,!1)}function o(){var s=navigator.userAgent.toLowerCase();return s.indexOf("chrome")>-1?"chrome":s.indexOf("firefox")>-1?"firefox":s.indexOf("opera")>-1?"opera":s.indexOf("msie")>-1?"ie":s.indexOf("safari")>-1?"safari":void 0}function i(s,e,t,o){H.fillStyle=o,H.fillText(t,s+2,e-2)}function l(s,e,t,o){return Math.sqrt(Math.pow(t-s,2)+Math.pow(o-e,2))}function n(s,e,t,o,i){var r,l,n=s-t,a=e-o;return _r2=Math.sqrt(n*n+a*a),r=n>0?t+i/_r2*Math.abs(n):t-i/_r2*Math.abs(n),l=a>0?o+i/_r2*Math.abs(a):o-i/_r2*Math.abs(a),[r,l]}function a(s){4==s.length?(draw_dashed_line(s[0],s[1],s[0],s[3],"green"),draw_dashed_line(s[0],s[1],s[2],s[1],"green"),draw_dashed_line(s[0],s[3],s[2],s[3],"green"),draw_dashed_line(s[2],s[1],s[2],s[3],"green")):(draw_dashed_line(s[0],s[1],s[4],s[5],"green"),draw_dashed_line(s[0],s[1],s[6],s[7],"green"),draw_dashed_line(s[2],s[3],s[4],s[5],"green"),draw_dashed_line(s[2],s[3],s[6],s[7],"green"))}function h(s,e,t,o,i,r,a){var h=Math.atan2(i-t,o-e),c=h+s,_=l(e,t,o,i),p=1,d=(p-e)*Math.tan(c)+t,u=n(p,d,e,t,_);return l(r,a,u[0],u[1])<ys?u:[2*e-u[0],2*t-u[1]]}function c(s,e){for(var t=0;t<s.user.dot_points.length;t++)s.user.dot_points[t].length>0&&(s.user.dot_points[t][0]-=e[0],s.user.dot_points[t][1]-=e[1],bs.dot_points.push(s.user.dot_points[t]),gs.push("dot_points"));for(var t=0;t<s.user.cross_points.length;t++)s.user.cross_points[t].length>0&&(s.user.cross_points[t][0]-=e[0],s.user.cross_points[t][1]-=e[1],bs.cross_points.push(s.user.cross_points[t]),gs.push("cross_points"));for(var t=0;t<s.user.labels.length;t++)s.user.labels[t].length>0&&(s.user.labels[t][0]-=e[0],s.user.labels[t][1]-=e[1],bs.labels.push(s.user.labels[t]),gs.push("labels"));for(var t=0;t<s.user.solid_lines.length;t++)s.user.solid_lines[t].length>0&&(s.user.solid_lines[t][0]-=e[0],s.user.solid_lines[t][1]-=e[1],s.user.solid_lines[t][2]-=e[0],s.user.solid_lines[t][3]-=e[1],bs.solid_lines.push(s.user.solid_lines[t]),gs.push("solid_lines"));for(var t=0;t<s.user.dashed_lines.length;t++)s.user.dashed_lines[t].length>0&&(s.user.dashed_lines[t][0]-=e[0],s.user.dashed_lines[t][1]-=e[1],s.user.dashed_lines[t][2]-=e[0],s.user.dashed_lines[t][3]-=e[1],bs.dashed_lines.push(s.user.dashed_lines[t]),gs.push("dashed_lines"));for(var t=0;t<s.user.heights.length;t++)s.user.heights[t].length>0&&(s.user.heights[t][0]-=e[0],s.user.heights[t][1]-=e[1],s.user.heights[t][2]-=e[0],s.user.heights[t][3]-=e[1],s.user.heights[t][4]-=e[0],s.user.heights[t][5]-=e[1],s.user.heights[t][6]-=e[0],s.user.heights[t][7]-=e[1],s.user.heights[t][8]-=e[0],s.user.heights[t][9]-=e[1],bs.heights.push(s.user.heights[t]),gs.push("heights"));for(var t=0;t<s.user.circles.length;t++)s.user.circles[t].length>0&&(s.user.circles[t][0]-=e[0],s.user.circles[t][1]-=e[1],bs.circles.push(s.user.circles[t]),gs.push("circles"));for(var t=0;t<s.user.compass.length;t++)if(s.user.compass[t].length>0){for(var o=1;o<s.user.compass[t].length;o++)s.user.compass[t][o][0]-=e[0],s.user.compass[t][o][1]-=e[1];bs.compass.push(s.user.compass[t]),gs.push("compass")}}function _(s,e,t,o,i){if(null!=e||null!=t||null!=o)p(bs,s.user,e,t,o,i),p(Ms,s.author,e,t,o,i);else{for(var r=0;r<s.user.dot_points.length;r++)s.user.dot_points[r].length>0&&(bs.dot_points[r][0]=-1,bs.dot_points[r][1]=-1);for(var r=0;r<s.user.cross_points.length;r++)s.user.cross_points[r].length>0&&(bs.cross_points[r][0]=-1,bs.cross_points[r][1]=-1);for(var r=0;r<s.user.labels.length;r++)s.user.labels[r].length>0&&(bs.labels[r][0]=-1,bs.labels[r][1]=-1);for(var r=0;r<s.user.solid_lines.length;r++)s.user.solid_lines[r].length>0&&(bs.solid_lines[r][0]=-1,bs.solid_lines[r][1]=-1,bs.solid_lines[r][2]=-1,bs.solid_lines[r][3]=-1);for(var r=0;r<s.user.dashed_lines.length;r++)s.user.dashed_lines[r].length>0&&(bs.dashed_lines[r][0]=-1,bs.dashed_lines[r][1]=-1,bs.dashed_lines[r][2]=-1,bs.dashed_lines[r][3]=-1);for(var r=0;r<s.user.heights.length;r++)s.user.heights[r].length>0&&(bs.heights[r][0]=-1,bs.heights[r][1]=-1,bs.heights[r][2]=-1,bs.heights[r][3]=-1,bs.heights[r][4]=-1,bs.heights[r][5]=-1,bs.heights[r][6]=-1,bs.heights[r][7]=-1,bs.heights[r][8]=-1,bs.heights[r][9]=-1);for(var r=0;r<s.user.circles.length;r++)s.user.circles[r].length>0&&(bs.circles[r][0]=-1,bs.circles[r][1]=-1,bs.circles[r][2]=0);for(var r=0;r<s.user.compass.length;r++)s.user.compass[r].length>0&&(bs.compass[r]=[])}}function p(s,e,t,o,i,r){for(var l=0;l<e.dot_points.length;l++)if(e.dot_points[l].length>0)if(null!=r)_rotate_points=h(r[0],r[1],r[2],e.dot_points[l][0],e.dot_points[l][1],s.dot_points[l][0],s.dot_points[l][1]),s.dot_points[l][0]=_rotate_points[0],s.dot_points[l][1]=_rotate_points[1];else if(0==i.length)s.dot_points[l][0]=e.dot_points[l][0]+t,s.dot_points[l][1]=e.dot_points[l][1]+o;else if(null!=i[0]){var n=(i[0]-e.dot_points[l][0])/Math.abs(i[0]-e.dot_points[l][0]),a=Math.abs(e.dot_points[l][0]-i[0])*t/Math.abs(i[2]);s.dot_points[l][0]=e.dot_points[l][0]+n*a}else if(null!=i[1]){var n=(i[1]-e.dot_points[l][1])/Math.abs(i[1]-e.dot_points[l][1]),a=Math.abs(e.dot_points[l][1]-i[1])*o/Math.abs(i[3]);s.dot_points[l][1]=e.dot_points[l][1]+n*a}for(var l=0;l<e.cross_points.length;l++)if(e.cross_points[l].length>0)if(null!=r)_rotate_points=h(r[0],r[1],r[2],e.cross_points[l][0],e.cross_points[l][1],s.cross_points[l][0],s.cross_points[l][1]),s.cross_points[l][0]=_rotate_points[0],s.cross_points[l][1]=_rotate_points[1];else if(0==i.length)s.cross_points[l][0]=e.cross_points[l][0]+t,s.cross_points[l][1]=e.cross_points[l][1]+o;else if(null!=i[0]){var n=(i[0]-e.cross_points[l][0])/Math.abs(i[0]-e.cross_points[l][0]),a=Math.abs(e.cross_points[l][0]-i[0])*t/Math.abs(i[2]);s.cross_points[l][0]=e.cross_points[l][0]+n*a}else if(null!=i[1]){var n=(i[1]-e.cross_points[l][1])/Math.abs(i[1]-e.cross_points[l][1]),a=Math.abs(e.cross_points[l][1]-i[1])*o/Math.abs(i[3]);s.cross_points[l][1]=e.cross_points[l][1]+n*a}for(var l=0;l<e.labels.length;l++)if(e.labels[l].length>0)if(null!=r)_rotate_points=h(r[0],r[1],r[2],e.labels[l][0],e.labels[l][1],s.labels[l][0],s.labels[l][1]),s.labels[l][0]=_rotate_points[0],s.labels[l][1]=_rotate_points[1];else if(0==i.length)s.labels[l][0]=e.labels[l][0]+t,s.labels[l][1]=e.labels[l][1]+o;else if(null!=i[0]){var n=(i[0]-e.labels[l][0])/Math.abs(i[0]-e.labels[l][0]),a=Math.abs(e.labels[l][0]-i[0])*t/Math.abs(i[2]);s.labels[l][0]=e.labels[l][0]+n*a}else if(null!=i[1]){var n=(i[1]-e.labels[l][1])/Math.abs(i[1]-e.labels[l][1]),a=Math.abs(e.labels[l][1]-i[1])*o/Math.abs(i[3]);s.labels[l][1]=e.labels[l][1]+n*a}for(var l=0;l<e.solid_lines.length;l++)if(e.solid_lines[l].length>0)if(null!=r)_rotate_points=h(r[0],r[1],r[2],e.solid_lines[l][0],e.solid_lines[l][1],s.solid_lines[l][0],s.solid_lines[l][1]),s.solid_lines[l][0]=_rotate_points[0],s.solid_lines[l][1]=_rotate_points[1],_rotate_points=h(r[0],r[1],r[2],e.solid_lines[l][2],e.solid_lines[l][3],s.solid_lines[l][2],s.solid_lines[l][3]),s.solid_lines[l][2]=_rotate_points[0],s.solid_lines[l][3]=_rotate_points[1];else if(0==i.length)s.solid_lines[l][0]=e.solid_lines[l][0]+t,s.solid_lines[l][1]=e.solid_lines[l][1]+o,s.solid_lines[l][2]=e.solid_lines[l][2]+t,s.solid_lines[l][3]=e.solid_lines[l][3]+o;else if(null!=i[0]){var n=(i[0]-e.solid_lines[l][0])/Math.abs(i[0]-e.solid_lines[l][0]),a=Math.abs(e.solid_lines[l][0]-i[0])*t/Math.abs(i[2]);s.solid_lines[l][0]=e.solid_lines[l][0]+n*a;var n=(i[0]-e.solid_lines[l][2])/Math.abs(i[0]-e.solid_lines[l][2]),a=Math.abs(e.solid_lines[l][2]-i[0])*t/Math.abs(i[2]);s.solid_lines[l][2]=e.solid_lines[l][2]+n*a}else if(null!=i[1]){var n=(i[1]-e.solid_lines[l][1])/Math.abs(i[1]-e.solid_lines[l][1]),a=Math.abs(e.solid_lines[l][1]-i[1])*o/Math.abs(i[3]);s.solid_lines[l][1]=e.solid_lines[l][1]+n*a;var n=(i[1]-e.solid_lines[l][3])/Math.abs(i[1]-e.solid_lines[l][3]),a=Math.abs(e.solid_lines[l][3]-i[1])*o/Math.abs(i[3]);s.solid_lines[l][3]=e.solid_lines[l][3]+n*a}for(var l=0;l<e.dashed_lines.length;l++)if(e.dashed_lines[l].length>0)if(null!=r)_rotate_points=h(r[0],r[1],r[2],e.dashed_lines[l][0],e.dashed_lines[l][1],s.dashed_lines[l][0],s.dashed_lines[l][1]),s.dashed_lines[l][0]=_rotate_points[0],s.dashed_lines[l][1]=_rotate_points[1],_rotate_points=h(r[0],r[1],r[2],e.dashed_lines[l][2],e.dashed_lines[l][3],s.dashed_lines[l][2],s.dashed_lines[l][3]),s.dashed_lines[l][2]=_rotate_points[0],s.dashed_lines[l][3]=_rotate_points[1];else if(0==i.length)s.dashed_lines[l][0]=e.dashed_lines[l][0]+t,s.dashed_lines[l][1]=e.dashed_lines[l][1]+o,s.dashed_lines[l][2]=e.dashed_lines[l][2]+t,s.dashed_lines[l][3]=e.dashed_lines[l][3]+o;else if(null!=i[0]){var n=(i[0]-e.dashed_lines[l][0])/Math.abs(i[0]-e.dashed_lines[l][0]),a=Math.abs(e.dashed_lines[l][0]-i[0])*t/Math.abs(i[2]);s.dashed_lines[l][0]=e.dashed_lines[l][0]+n*a;var n=(i[0]-e.dashed_lines[l][2])/Math.abs(i[0]-e.dashed_lines[l][2]),a=Math.abs(e.dashed_lines[l][2]-i[0])*t/Math.abs(i[2]);s.dashed_lines[l][2]=e.dashed_lines[l][2]+n*a}else if(null!=i[1]){var n=(i[1]-e.dashed_lines[l][1])/Math.abs(i[1]-e.dashed_lines[l][1]),a=Math.abs(e.dashed_lines[l][1]-i[1])*o/Math.abs(i[3]);s.dashed_lines[l][1]=e.dashed_lines[l][1]+n*a;var n=(i[1]-e.dashed_lines[l][3])/Math.abs(i[1]-e.dashed_lines[l][3]),a=Math.abs(e.dashed_lines[l][3]-i[1])*o/Math.abs(i[3]);s.dashed_lines[l][3]=e.dashed_lines[l][3]+n*a}for(var l=0;l<e.heights.length;l++)if(e.heights[l].length>0)if(null!=r)_rotate_points=h(r[0],r[1],r[2],e.heights[l][0],e.heights[l][1],s.heights[l][0],s.heights[l][1]),s.heights[l][0]=_rotate_points[0],s.heights[l][1]=_rotate_points[1],_rotate_points=h(r[0],r[1],r[2],e.heights[l][2],e.heights[l][3],s.heights[l][2],s.heights[l][3]),s.heights[l][2]=_rotate_points[0],s.heights[l][3]=_rotate_points[1],_rotate_points=h(r[0],r[1],r[2],e.heights[l][4],e.heights[l][5],s.heights[l][4],s.heights[l][5]),s.heights[l][4]=_rotate_points[0],s.heights[l][5]=_rotate_points[1],_rotate_points=h(r[0],r[1],r[2],e.heights[l][6],e.heights[l][7],s.heights[l][6],s.heights[l][7]),s.heights[l][6]=_rotate_points[0],s.heights[l][7]=_rotate_points[1],_rotate_points=h(r[0],r[1],r[2],e.heights[l][8],e.heights[l][9],s.heights[l][8],s.heights[l][9]),s.heights[l][8]=_rotate_points[0],s.heights[l][9]=_rotate_points[1];else if(0==i.length)s.heights[l][0]=e.heights[l][0]+t,s.heights[l][1]=e.heights[l][1]+o,s.heights[l][2]=e.heights[l][2]+t,s.heights[l][3]=e.heights[l][3]+o,s.heights[l][4]=e.heights[l][4]+t,s.heights[l][5]=e.heights[l][5]+o,s.heights[l][6]=e.heights[l][6]+t,s.heights[l][7]=e.heights[l][7]+o,s.heights[l][8]=e.heights[l][8]+t,s.heights[l][9]=e.heights[l][9]+o;else if(null!=i[0]){var n=(i[0]-e.heights[l][0])/Math.abs(i[0]-e.heights[l][0]),a=Math.abs(e.heights[l][0]-i[0])*t/Math.abs(i[2]);s.heights[l][0]=e.heights[l][0]+n*a;var n=(i[0]-e.heights[l][2])/Math.abs(i[0]-e.heights[l][2]),a=Math.abs(e.heights[l][2]-i[0])*t/Math.abs(i[2]);s.heights[l][2]=e.heights[l][2]+n*a;var n=(i[0]-e.heights[l][4])/Math.abs(i[0]-e.heights[l][4]),a=Math.abs(e.heights[l][4]-i[0])*t/Math.abs(i[2]);s.heights[l][4]=e.heights[l][4]+n*a;var n=(i[0]-e.heights[l][6])/Math.abs(i[0]-e.heights[l][6]),a=Math.abs(e.heights[l][6]-i[0])*t/Math.abs(i[2]);s.heights[l][6]=e.heights[l][6]+n*a;var n=(i[0]-e.heights[l][8])/Math.abs(i[0]-e.heights[l][8]),a=Math.abs(e.heights[l][8]-i[0])*t/Math.abs(i[2]);s.heights[l][8]=e.heights[l][8]+n*a}else if(null!=i[1]){var n=(i[1]-e.heights[l][1])/Math.abs(i[1]-e.heights[l][1]),a=Math.abs(e.heights[l][1]-i[1])*o/Math.abs(i[3]);s.heights[l][1]=e.heights[l][1]+n*a;var n=(i[1]-e.heights[l][3])/Math.abs(i[1]-e.heights[l][3]),a=Math.abs(e.heights[l][3]-i[1])*o/Math.abs(i[3]);s.heights[l][3]=e.heights[l][3]+n*a;var n=(i[1]-e.heights[l][5])/Math.abs(i[1]-e.heights[l][5]),a=Math.abs(e.heights[l][5]-i[1])*o/Math.abs(i[3]);s.heights[l][5]=e.heights[l][5]+n*a;var n=(i[1]-e.heights[l][7])/Math.abs(i[1]-e.heights[l][7]),a=Math.abs(e.heights[l][7]-i[1])*o/Math.abs(i[3]);s.heights[l][7]=e.heights[l][7]+n*a;var n=(i[1]-e.heights[l][9])/Math.abs(i[1]-e.heights[l][9]),a=Math.abs(e.heights[l][9]-i[1])*o/Math.abs(i[3]);s.heights[l][9]=e.heights[l][9]+n*a}for(var l=0;l<e.circles.length;l++)if(e.circles[l].length>0)if(null!=r)_rotate_points=h(r[0],r[1],r[2],e.circles[l][0],e.circles[l][1],s.circles[l][0],s.circles[l][1]),s.circles[l][0]=_rotate_points[0],s.circles[l][1]=_rotate_points[1];else if(0==i.length)s.circles[l][0]=e.circles[l][0]+t,s.circles[l][1]=e.circles[l][1]+o,s.circles[l][2]=e.circles[l][2];else if(null!=i[0]){var n=(i[0]-e.circles[l][0])/Math.abs(i[0]-e.circles[l][0]),a=Math.abs(e.circles[l][0]-i[0])*t/Math.abs(i[2]);s.circles[l][0]=e.circles[l][0]+n*a}else if(null!=i[1]){var n=(i[1]-e.circles[l][1])/Math.abs(i[1]-e.circles[l][1]),a=Math.abs(e.circles[l][1]-i[1])*o/Math.abs(i[3]);s.circles[l][1]=e.circles[l][1]+n*a}for(var l=0;l<e.compass.length;l++)if(e.compass[l].length>0)if(s.compass[l][0]=e.compass[l][0],null!=r)for(var c=1;c<e.compass[l].length;c++)_rotate_points=h(r[0],r[1],r[2],e.compass[l][c][0],e.compass[l][c][1],s.compass[l][c][0],s.compass[l][c][1]),s.compass[l][c][0]=_rotate_points[0],s.compass[l][c][1]=_rotate_points[1];else if(0==i.length)for(var c=1;c<e.compass[l].length;c++)s.compass[l][c]=[],s.compass[l][c][0]=e.compass[l][c][0]+t,s.compass[l][c][1]=e.compass[l][c][1]+o;else if(null!=i[0])for(var c=1;c<e.compass[l].length;c++){var n=(i[0]-e.compass[l][c][0])/Math.abs(i[0]-e.compass[l][c][0]),a=Math.abs(e.compass[l][c][0]-i[0])*t/Math.abs(i[2]);s.compass[l][c][0]=e.compass[l][c][0]+n*a}else if(null!=i[1])for(var c=1;c<e.compass[l].length;c++){var n=(i[1]-e.compass[l][c][1])/Math.abs(i[1]-e.compass[l][c][1]),a=Math.abs(e.compass[l][c][1]-i[1])*o/Math.abs(i[3]);s.compass[l][c][1]=e.compass[l][c][1]+n*a}}function d(){H.clearRect(0,0,D.width,D.height),v()}function u(s){fs.cross=!0,fs.dot=!0,fs.solid_line=!0,fs.solid_line_move=!0,fs.dashed_line=!0,fs.dashed_line_move=!0,fs.label=!0,fs.circle=!0,fs.circle_move=!0,fs.compass=!0,fs.compass_rad=!0,fs.compass_draw=!0,fs.ruler=!0,fs.protr=!0,fs.height=!0,fs.height_move=!0,fs.select=!0,fs.select_move=!0,fs.trans=!0,fs.del=!0,fs.copy=!0,us=x2=y1=y2=null,ms=null;for(var e=0;e<s.length;e++)fs[s[e]]=!1}function x(s){null!=s?(bs.cross_points=null!=s.x?s.x:[],bs.dot_points=null!=s.d?s.d:[],bs.solid_lines=null!=s.s?s.s:[],bs.dashed_lines=null!=s.i?s.i:[],bs.circles=null!=s.o?s.o:[],bs.compass=null!=s.v?s.v:[],bs.labels=null!=s.l?s.l:[],bs.ruler=null!=s.r?s.r:[],bs.protr=null!=s.p?s.p:[],bs.heights=null!=s.hg?s.hg:[],gs=null!=s.u?s.u:[]):(bs.cross_points=[],bs.dot_points=[],bs.solid_lines=[],bs.dashed_lines=[],bs.circles=[],bs.compass=[],bs.labels=[],bs.ruler=[],bs.protr=[],bs.heights=[],gs=[]),y()}function y(){ws.cross_points=[],ws.dot_points=[],ws.solid_lines=[],ws.dashed_lines=[],ws.circles=[],ws.compass=[],ws.labels=[],ws.ruler=[],ws.protr=[],ws.heights=[],xs=[],rs.firstChild.src="src/core/img/redo-passive.png",bs.select=[],bs.trans=[],bs.del=[],ws.trans=[],ws.del=[]}function m(s){bs[s]=[];for(var e=0;e<gs.length;e++)gs[e]==s&&(gs.splice(e,1),e--)}function v(){t(),cs.style.display="none";for(var s=0;s<bs.cross_points.length;s++)plot_point_cross(bs.cross_points[s][0],bs.cross_points[s][1],bs.cross_points[s][2]);for(var s=0;s<bs.dot_points.length;s++)plot_point_circle(bs.dot_points[s][0],bs.dot_points[s][1],bs.dot_points[s][2]);for(var s=0;s<bs.labels.length;s++)i(bs.labels[s][0],bs.labels[s][1],bs.labels[s][2],bs.labels[s][3]);for(var s=0;s<bs.solid_lines.length;s++)draw_solid_line(bs.solid_lines[s][0],bs.solid_lines[s][1],bs.solid_lines[s][2],bs.solid_lines[s][3],bs.solid_lines[s][4]);for(var s=0;s<bs.dashed_lines.length;s++)draw_dashed_line(bs.dashed_lines[s][0],bs.dashed_lines[s][1],bs.dashed_lines[s][2],bs.dashed_lines[s][3],bs.dashed_lines[s][4]);for(var s=0;s<bs.heights.length;s++)draw_solid_line(bs.heights[s][0],bs.heights[s][1],bs.heights[s][2],bs.heights[s][3],bs.heights[s][16]),draw_solid_line(bs.heights[s][4],bs.heights[s][5],bs.heights[s][8],bs.heights[s][9],bs.heights[s][16]),draw_solid_line(bs.heights[s][6],bs.heights[s][7],bs.heights[s][8],bs.heights[s][9],bs.heights[s][16]);for(var s=0;s<bs.circles.length;s++)plot_point_circle(bs.circles[s][0],bs.circles[s][1],bs.circles[s][3]),draw_arc(bs.circles[s][0],bs.circles[s][1],bs.circles[s][2],0,2*Math.PI,!1,bs.circles[s][3]);for(var s=0;s<bs.compass.length;s++)if(bs.compass[s].length>0)for(var e=bs.compass[s][1][0],o=bs.compass[s][1][1],r=2;r<bs.compass[s].length;r++){
var l=bs.compass[s][r][0],n=bs.compass[s][r][1];draw_solid_line(e,o,l,n,bs.compass[s][0]),e=l,o=n}if(bs.ruler.length>0){var h=bs.ruler[0],c=bs.ruler[1],e=bs.ruler[2],o=bs.ruler[3],_=Math.atan2(o-c,e-h);H.save(),H.translate(h,c),H.rotate(_),H.drawImage(ps,0,0),H.restore()}if(bs.protr.length>0){var p=bs.protr[0],d=bs.protr[1],e=bs.protr[2],o=bs.protr[3],h=(p+e)/2,c=(d+o)/2,_=Math.atan2(o-c,e-h);H.save(),H.translate(h,c),H.rotate(_),H.drawImage(_s,-136,-137),H.restore()}bs.select.length>0&&a(bs.select)}function f(s,e,t,o){var i=document.createElement("button");i.id=s.id+"-"+t.replace(" ","-"),i.className="geo2d-btn";var r=document.createElement("img");return r.src=e,i.appendChild(r),s.appendChild(i),i}function b(s,e,t){var o=document.createElement("select");o.style.width="109px",o.style.margin="5px",s.appendChild(o);for(var i=0;i<e.length;i++){var r=document.createElement("option");r.value=e[i],r.innerHTML=t[i],o.appendChild(r)}return o}function M(s,e,t){"geo2d-btn"!=s.className?(s.className="geo2d-btn",u([]),$.inArray("ruler",e)>-1&&(bs.ruler=[]),$.inArray("protr",e)>-1&&(bs.protr=[])):(S(),s.className="geo2d-btn-onclick",null!=e&&u(e)),bs.select=[],D.style.cursor="default",d()}function S(){for(var s=document.getElementsByClassName("geo2d-btn-onclick"),e=0;e<s.length;e++)s[e].className="geo2d-btn"}function C(){switch(caller){case"group":"0"==group_type?socket.emit("free-group-client-data",JSON.stringify({ws_id:F,delta:JSON.stringify(k())})):socket.emit("assigned-group-client-data",JSON.stringify({g:g,w:w,q:q,ws_id:F,delta:JSON.stringify(k())}));break;case"practice":socket.emit("practice-client-data",JSON.stringify({ws_id:F,data:JSON.stringify(k())}));break;case"whiteboard":socket.emit("whiteboard-client-data",JSON.stringify({ws_id:F,data:JSON.stringify(k())}))}}function E(s){s=JSON.parse(s),L=s.w,A=s.h,U=s._,bs.cross_points=null!=s.x?s.x:[],bs.dot_points=null!=s.d?s.d:[],bs.solid_lines=null!=s.s?s.s:[],bs.dashed_lines=null!=s.i?s.i:[],bs.circles=null!=s.o?s.o:[],bs.compass=null!=s.v?s.v:[],bs.labels=null!=s.l?s.l:[],bs.heights=null!=s.hg?s.hg:[],bs.ruler=null!=s.r?s.r:[],bs.protr=null!=s.p?s.p:[],gs=null!=s.u?s.u:[]}function k(){var s={};return s.w=L,s.h=A,s._=U,bs.cross_points=T(bs.cross_points),bs.cross_points.length>0&&(s.x=bs.cross_points),bs.dot_points=T(bs.dot_points),bs.dot_points.length>0&&(s.d=bs.dot_points),bs.solid_lines=T(bs.solid_lines),bs.solid_lines.length>0&&(s.s=bs.solid_lines),bs.dashed_lines=T(bs.dashed_lines),bs.dashed_lines.length>0&&(s.i=bs.dashed_lines),bs.circles=T(bs.circles),bs.circles.length>0&&(s.o=bs.circles),bs.compass=T(bs.compass),bs.compass.length>0&&(s.v=bs.compass),bs.labels=T(bs.labels),bs.labels.length>0&&(s.l=bs.labels),bs.heights=T(bs.heights),bs.heights.length>0&&(s.hg=bs.heights),bs.ruler.length>0&&(s.r=bs.ruler),bs.protr.length>0&&(s.p=bs.protr),s}function T(s){for(var e=0;e<s.length;e++)s[e].indexOf(-1)>-1&&s.splice(e--,1);return s}function N(){return vs}function I(s){null!=s.c?(x({}),P={}):null!=s.u?(null==P[s.u[0]]&&(P[s.u[0]]={}),P[s.u[0]][s.u]=s.u[2],R(s.u[0])):null!=s.rt?(null!=P[s.rt]&&delete P[s.rt],bs[s.rt]=[]):null!=s.r&&null!=P[s.r[0]][s.r[1]]&&(delete P[s.r[0]][s.r[1]],R(s.r[0])),d()}function R(s){bs[s]=[];for(var e in P[s])P[s].hasOwnProperty(e)&&bs[s].push(P[s][e])}var F=s.id+"-geoshare",P={},O=!1,L=null!=e&&null!=e.w?parseInt(e.w):6,A=null!=e&&null!=e.h?parseInt(e.h):6,Y=null!=e&&null!=e.text_font?e.text_font:"15px verdana",X=o(),D=document.createElement("canvas");D.id=s.id+"-canvas";var H=D.getContext("2d"),G=10,U=5*G;D.height=A*U,D.width=L*U,s.appendChild(D),s.appendChild(document.createElement("br"));var J=f(s,"src/core/img/line.png","Solid Line","top"),K=f(s,"src/core/img/dash.png","Dashed Line","top"),z=f(s,"src/core/img/circle.png","Circle","top"),W=f(s,"src/core/img/cross.png","Crossed Point","top"),j=f(s,"src/core/img/dot.png","Dotted Point","top"),B=f(s,"src/core/img/label.png","Text Label","top"),V=f(s,"src/core/img/height.png","Height","top");s.appendChild(document.createElement("br"));var Q=f(s,"src/core/img/compass.png","Compass","top"),Z=f(s,"src/core/img/protr_label.png","Protractor","bottom"),ss=f(s,"src/core/img/ruler.png","Ruler","bottom"),es=f(s,"src/core/img/select.png","Select","top"),ts=f(s,"src/core/img/del-passive.png","Delete","top"),os=f(s,"src/core/img/copy-passive.png","Copy","top");s.appendChild(document.createElement("br"));var is=f(s,"src/core/img/undo-passive.png","Undo","left"),rs=f(s,"src/core/img/redo-passive.png","Redo","left"),ls=["none","solid_lines","dashed_lines","circles","cross_points","dot_points","compass","labels","ruler","protractor","all"],ns=["Clear","Solid Lines","Dashed Lines","Circles","Cross Points","Dotted Points","Compass","Labels","Ruler","Protractor","All"],as=b(s,ls,ns);if("chrome"==X||"firefox"==X){var hs=document.createElement("input");hs.type="color",hs.style.margin="5px",hs.style.width="17px",s.appendChild(hs),hs.onchange=function(){ds=hs.value}}var cs=document.createElement("input");s.appendChild(cs),cs.style.display="none",cs.style.zIndex="99999";var _s=document.createElement("img");_s.src="src/core/img/protractor.png";var ps=document.createElement("img");ps.src="src/core/img/ruler-"+(Math.max(L,A)-1)+".png";var ds="black",us=y1=x2=y2=null,gs=(oy=r=r2=r3=null,[]),xs=[],ys=G,ms=null,vs=!1,fs=(Math.max(D.height,D.width)/2,{});u([]);var bs={},Ms={},ws={};return 0!=gs.length&&(is.firstChild.src="src/core/img/undo-active.png"),W.onmousedown=function(){M(this,["cross"],"<i>INSTRUCTIONS</i><br><br>Locate point > CLICK")},j.onmousedown=function(){M(this,["dot"],"<i>INSTRUCTIONS</i><br><br>Locate point > CLICK")},B.onmousedown=function(){M(this,["label"],"<i>INSTRUCTIONS</i><br><br>Locate label > CLICK<br>TYPE > <i>Enter</i>")},V.onmousedown=function(){M(this,["height"],"<i>INSTRUCTIONS</i><br><br>PRESS > DRAG > RELEASE")},J.onmousedown=function(){M(this,["solid_line"],"<i>INSTRUCTIONS</i><br><br>PRESS > DRAG > RELEASE")},K.onmousedown=function(){M(this,["dashed_line"],"<i>INSTRUCTIONS</i><br><br>PRESS > DRAG > RELEASE")},z.onmousedown=function(){M(this,["circle"],"<i>INSTRUCTIONS</i><br><br>Locate center<br>PRESS > DRAG > RELEASE")},Q.onmousedown=function(){M(this,["compass"],"<i>INSTRUCTIONS</i><br><br>Locate center > CLICK > RELEASE<br>MOVE for radius<br>PRESS > DRAG > RELEASE")},ss.onmousedown=function(){M(this,["ruler"],"<i>INSTRUCTIONS</i><br><br>Locate position > CLICK<br>Locate angle > CLICK")},Z.onmousedown=function(){M(this,["protr"],"<i>INSTRUCTIONS</i><br><br>Locate position > CLICK<br>Locate angle > CLICK")},is.onmousedown=function(){if(bs.select=[],gs.length>0){if(s=!1,0==xs.length||"trans"!=xs[xs.length-1])var s=!0;var e=gs.pop();xs.push(e);var t=bs[e].pop();if(ws[e].push(t),"trans"==e){if(s){var e=gs.pop();xs.push(e);var t=bs[e].pop();ws[e].push(t)}_(t,0,0,[])}else"del"==e&&_(t,0,0,[]);d(),O&&C(),rs.firstChild.src="src/core/img/redo-active.png"}0==gs.length&&(is.firstChild.src="src/core/img/undo-passive.png"),vs=!0},rs.onmousedown=function(){if(bs.select=[],xs.length>0){if(s=!1,0==gs.length||"trans"!=gs[gs.length-1])var s=!0;var e=xs.pop();gs.push(e);var t=ws[e].pop();if(bs[e].push(t),"trans"==e){if(s){var e=xs.pop();gs.push(e);var t=ws[e].pop();bs[e].push(t)}_(t,0,0,[])}else"del"==e&&_(t,null,null,null);d(),O&&C(),is.firstChild.src="src/core/img/undo-active.png"}0==xs.length&&(rs.firstChild.src="src/core/img/redo-passive.png"),vs=!0},as.onchange=function(){if("all"==this.options[this.selectedIndex].value){var s=confirm("Are you sure you want to reset everything?");s&&x({})}else m(this.options[this.selectedIndex].value);S(),this.selectedIndex=0,u([]),d(),O&&C(),0==gs.length&&(is.firstChild.src="src/core/img/undo-passive.png"),vs=!0},es.onmousedown=function(){M(this,["select"],"<i>INSTRUCTIONS</i><br><br>DRAG TO SELECT")},ts.onmousedown=function(){null!=ms&&(_(ms,null,null,null),this.firstChild.src="src/core/img/del-passive.png",os.firstChild.src="src/core/img/copy-passive.png",bs.del.push(ms),gs.push("del"),bs.select=[],D.style.cursor="default",u([]),S(),d())},os.onmousedown=function(){null!=ms&&(c(ms,bs.select),ts.firstChild.src="src/core/img/del-passive.png",this.firstChild.src="src/core/img/copy-passive.png",bs.select=[],D.style.cursor="default",u([]),S(),d())},mouse_down_handler=function(s){s.preventDefault(),fs.cross||cross_down(s),fs.dot||dot_down(s),fs.solid_line||solid_down(s),fs.dashed_line||dashed_down(s),fs.height||height_down(s),fs.circle||circle_down(s),fs.ruler||ruler_down(s),fs.compass||compass_down(s),fs.protr||protr_down(s),fs.label||label_down(s),fs.select||select_down(s),O&&C()},mouse_move_handler=function(s){s.preventDefault(),fs.solid_line_move||solid_move(s),fs.dashed_line_move||dashed_move(s),fs.height_move||height_move(s),fs.circle||circle_move(s),fs.ruler||ruler_move(s),fs.protr||protr_move(s),!fs.compass&&fs.compass_rad&&fs.compass_draw&&compass_move(s),fs.compass_rad||compass_radius(s),fs.compass_draw||compass_draw(s),fs.select||select_move(s)},mouse_up_handler=function(s){s.preventDefault(),fs.solid_line||solid_up(s),fs.dashed_line||dashed_up(s),fs.height||height_up(s),fs.circle||circle_up(s),fs.compass||compass_up(s),fs.ruler||ruler_up(s),fs.protr||protr_up(s),fs.select||select_up(s),O&&C()},Object.size=function(s){var e,t=0;for(e in s)s.hasOwnProperty(e)&&t++;return t},v(),{status:function(){return JSON.stringify(k())},modified:function(){return N()},restore:function(s){""!=s&&(E(s),d())},node_pull:function(s){console.log(s)},node_pull_delta:function(s){I(s)},switch_emitable:function(s){O=s},getType:function(){return"geo2d"},getID:function(){return ws_id},debug:function(){}}};